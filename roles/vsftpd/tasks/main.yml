---
# file: roles/vsftpd/tasks/main.yml
- name: packages install
  yum:
    name: {{item}}
    state: present
  with_items:
    - vsftpd

- name: add vsftpd pam.d settings
  template:
    src: vsftpd.virtual.j2
    dest: /etc/pam.d/vsftpd
    owner: root
    group: root
    mode: 0644
    backup: true
  register: is_vsftpd_pam_d_setting

- name: add vsftpd user
  template:
    src: login.txt.j2
    dest: /etc/vsftpd/login.txt
    owner: root
    group: root
    mode: 0600
    backup: true
  register: is_vsftpd_user
  notify:
    - vsftpd_user recreate

- name: vsftpd user db status
  stat:
    path: /etc/vsftpd/login.db
  register: user_db_status

- name: apply vsftpd user db permission
  file:
    path: /etc/vsftpd/login.db
    owner: root
    group: root
    mode: 0600
  when: user_db_status.stat.exists

- name: create vsftpd dir
  file:
    path: "{{ vsftp_dir }}"
    state: directory
    owner: {{common_user[0].name}}
    group: {{common_user[0].group}}

- name: add vsftpd settings
  template:
    src: vsftpd.conf.j2
    dest: /etc/vsftpd/vsftpd.conf
    owner: root
    group: root
    mode: 0600
    backup: true
  register: is_vsftpd_setting
  notify: vsftpd restart

- name: enable vsftpd services
  service:
    name: vsftpd
    state: started
    enabled: yes
